<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.picsion.user.dao.UserDao">

	<select id="getPicsionList" resultType="kr.or.picsion.user.dto.User">
		SELECT * FROM USERS
	</select>
	
	<select id="userList" resultType="kr.or.picsion.user.dto.User">
		select * from  USERS
	</select>
	
	<insert id="registerUser" parameterType="kr.or.picsion.user.dto.User" useGeneratedKeys="true" keyProperty="userNo">
		INSERT INTO USERS
			(userId, pwd, userName, roleNo)
		VALUES
			( #{userId}, #{pwd}, #{userName},  1)
	</insert>
	
	<insert id="insertProfile">
		INSERT INTO PROFILE (userNo,prPicture) VALUES	(#{userNo},'/assets/img/user.png')
	</insert>
	
	<select id="selectUser" resultType="kr.or.picsion.user.dto.User">
		SELECT * FROM USERS WHERE userId= #{userId}
	</select>
	
	<!-- userNo로 회원 정보 가져오기 -->
	<select id="selectUserNo" resultType="kr.or.picsion.user.dto.User">
		SELECT * FROM USERS WHERE userNo=#{userNo}
	</select>
	
	<!-- 회원의 프로필 정보 가져오기 -->
	<select id="selectProfile" resultType="kr.or.picsion.user.dto.User">
		SELECT * FROM PROFILE WHERE userNo=#{userNo}
	</select>
	
	<!-- 회원의 프로필, 회원 정보 가져오기 -->
	<select id="selectUserProfile" resultType="kr.or.picsion.user.dto.User">
		select u.*, p.prPicture, p.prContent from USERS u join PROFILE p on u.userNo=p.userNo where u.userNo=#{userNo};
	</select>
	
	
	<!-- 회원의 팔로워 리스트 (나를 따르는 회원)-->
	<select id="followerUserList" resultType="kr.or.picsion.user.dto.User">
		SELECT f.userNo as userNo, p.prPicture, p.prContent
		FROM FOLLOW f JOIN PROFILE p
		ON f.userNo=p.userNo
		WHERE f.followingUserNo=#{userNo}
	</select>
	
	<!-- 회원의 팔로잉 리스트 (내가 따르는 회원) -->
	<select id="followingUserList" resultType="kr.or.picsion.user.dto.User">
		SELECT f.followingUserNo as userNo, u.userId as userId, u.userName as userName, p.prPicture as prPicture, p.prContent as prContent
		FROM FOLLOW f JOIN PROFILE p ON f.followingUserNo=p.userNo
		              JOIN USERS u ON f.followingUserNo=u.userNo
		WHERE f.userNo=#{userNo}
	</select>
	
	<!-- 회원이 팔로잉하고 있는 회원인지 확인 -->
	<select id="followingConfirm" resultType="Integer">
		SELECT COUNT(*) FROM FOLLOW WHERE userNo=#{param1} AND followingUserNo=#{param2}
	</select>
	
	<!-- 팔로잉 insert -->
	<insert id="insertFollow">
		INSERT INTO FOLLOW VALUES(#{param1}, #{param2})
	</insert>
	
	<!-- 팔로잉 delete -->
	<delete id="deleteFollow">
		DELETE FROM FOLLOW WHERE userNo=#{param1} AND followingUserNo=#{param2}
	</delete>
	
	 <!-- 팔로잉 최신 사진 -->
    <select id="followingUserPictureList" resultType="kr.or.picsion.picture.dto.Picture">
    	SELECT f.followingUserNo as userNo, u.userName as userName, p.picNo as picNo, p.picPath as picPath, p.picReg as picReg
      	FROM USERS u join FOLLOW f on u.userNo = f.followingUserNo
                   join PICTURE p on u.userNo = p.userNo
                   where f.userNo = #{userNo}
                   order by p.picReg
    </select> 
    
    
  
     <!-- 팔로잉 최신 사진의 주인 --> 
    <select id="followingUserPictureOwnerList" resultType="kr.or.picsion.user.dto.User">
    	SELECT f.followingUserNo as userNo, u.userName as userName, p.picNo as picNo, p.picPath as picPath, p.picReg as picReg
      	FROM USERS u join FOLLOW f on u.userNo = f.followingUserNo
                   join PICTURE p on u.userNo = p.userNo
                   where f.userNo = #{userNo}
                   order by p.picReg
    </select> 
   
	
	<!-- 북마크한 사진 리스트 -->
	<select id="bookmarkPicList" resultType="kr.or.picsion.picture.dto.Picture">
		SELECT p.*
		FROM PICTURE p JOIN BOOKMARK b 
			ON p.picNo = b.picNo
		WHERE b.userNo=#{userNo}
	</select>
	
	<!-- 좋아요한 사진 리스트 -->
	<select id="respectPicList" resultType="kr.or.picsion.picture.dto.Picture">
		SELECT p.*
		FROM PICTURE p JOIN RESPECT r 
			ON p.picNo = r.picNo
		WHERE r.userNo=#{userNo}
	</select>
	
	<delete id="deleteUser">
		delete from USERS where userNo = #{userNo}
	</delete>
	
	<!-- 다른 사이트가 연동되어 있지 않는 경우 insert -->
	<insert id="insertAccount">
		insert into ACCOUNTLINKED (userNo, ${param3})
		values (#{param1}, #{param2})
	</insert>
	
	<!-- 이미 다른 사이트가 연동되어 있는 경우 update -->
	<update id="updateAccount">
		update ACCOUNTLINKED
		   set ${param3} =#{param2}
		 where userNo = #{param1}
	</update>
		
	<!-- 계정 연동 확인 -->
	<select id="selectAccountNo" resultType="kr.or.picsion.user.dto.User">
		select userNo, ${param2} from ACCOUNTLINKED where ${param2} = #{param1}
	</select>
	
	<select id="selectAccountUserNo" resultType="kr.or.picsion.user.dto.User">
		select * from ACCOUNTLINKED where userNo = #{userNo}
	</select>
	

</mapper>